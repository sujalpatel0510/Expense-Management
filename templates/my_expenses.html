{% extends "base.html" %}

{% block title %}My Expenses - Expense Management{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h1 class="card-title">My Expenses</h1>
        <a href="{{ url_for('new_expense') }}" class="btn btn-primary">
            <svg fill="currentColor" viewBox="0 0 24 24" width="20" height="20" style="vertical-align: middle; margin-right: 0.5rem;">
                <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
            </svg>
            New Expense
        </a>
    </div>

    <div class="stats-grid" style="margin-bottom: 2rem;">
        <div class="stat-card">
            <div class="stat-icon primary">
                <svg fill="currentColor" viewBox="0 0 24 24" width="28" height="28">
                    <path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1z"/>
                </svg>
            </div>
            <div class="stat-content">
                <h3>{{ expenses|length }}</h3>
                <p>Total Submitted</p>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon warning">
                <svg fill="currentColor" viewBox="0 0 24 24" width="28" height="28">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                </svg>
            </div>
            <div class="stat-content">
                <h3>{{ expenses|selectattr('status', 'equalto', 'pending')|list|length }}</h3>
                <p>Pending</p>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon success">
                <svg fill="currentColor" viewBox="0 0 24 24" width="28" height="28">
                    <path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"/>
                </svg>
            </div>
            <div class="stat-content">
                <h3>{{ expenses|selectattr('status', 'equalto', 'approved')|list|length }}</h3>
                <p>Approved</p>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon danger">
                <svg fill="currentColor" viewBox="0 0 24 24" width="28" height="28">
                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                </svg>
            </div>
            <div class="stat-content">
                <h3>{{ expenses|selectattr('status', 'equalto', 'rejected')|list|length }}</h3>
                <p>Rejected</p>
            </div>
        </div>
    </div>

    {% if expenses %}
    <div style="margin-bottom: 1.5rem;">
        <input type="text" id="searchBox" class="form-control" placeholder="üîç Search by category, description, or amount..." onkeyup="filterTable()">
    </div>

    <div class="table-container">
        <table id="expensesTable">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Category</th>
                    <th>Description</th>
                    <th>Amount</th>
                    <th>Status</th>
                    <th>Submitted</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for exp in expenses %}
                <tr>
                    <td>{{ exp.expense_date.strftime('%Y-%m-%d') }}</td>
                    <td><strong>{{ exp.category }}</strong></td>
                    <td>{{ exp.description[:50] }}{% if exp.description and exp.description|length > 50 %}...{% endif %}</td>
                    <td>
                        <strong>{{ exp.currency }} {{ "%.2f"|format(exp.amount) }}</strong>
                        {% if exp.currency != current_user.company.currency %}
                        <br><small style="color: var(--gray);">({{ current_user.company.currency }} {{ "%.2f"|format(exp.amount_company_ccy) }})</small>
                        {% endif %}
                    </td>
                    <td>
                        {% if exp.status == 'approved' %}
                        <span class="badge badge-success">‚úì Approved</span>
                        {% elif exp.status == 'rejected' %}
                        <span class="badge badge-danger">‚úó Rejected</span>
                        {% elif exp.status == 'pending' %}
                        <span class="badge badge-warning">‚è≥ Pending</span>
                        {% else %}
                        <span class="badge badge-secondary">{{ exp.status|title }}</span>
                        {% endif %}
                    </td>
                    <td>
                        <small style="color: var(--gray);">{{ exp.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                    </td>
                    <td>
                        <button onclick="viewDetails({{ exp.id }})" class="btn btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.875rem;">
                            View Details
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="empty-state">
        <svg fill="currentColor" viewBox="0 0 24 24">
            <path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm2 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
        </svg>
        <h3>No Expenses Yet</h3>
        <p>Start by submitting your first expense claim</p>
        <a href="{{ url_for('new_expense') }}" class="btn btn-primary" style="margin-top: 1rem;">Submit Expense</a>
    </div>
    {% endif %}
</div>

<!-- Modal for expense details -->
<div id="detailsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center;">
    <div style="background: white; border-radius: 16px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; padding: 2rem; position: relative;">
        <button onclick="closeModal()" style="position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--gray);">√ó</button>
        <h2 style="margin-bottom: 1.5rem; color: var(--dark);">Expense Details</h2>
        <div id="modalContent"></div>
    </div>
</div>

<script>
    function filterTable() {
        const input = document.getElementById('searchBox');
        const filter = input.value.toLowerCase();
        const table = document.getElementById('expensesTable');
        const rows = table.getElementsByTagName('tr');

        for (let i = 1; i < rows.length; i++) {
            const cells = rows[i].getElementsByTagName('td');
            let found = false;
            
            for (let j = 0; j < cells.length; j++) {
                if (cells[j].textContent.toLowerCase().indexOf(filter) > -1) {
                    found = true;
                    break;
                }
            }
            
            rows[i].style.display = found ? '' : 'none';
        }
    }

    function viewDetails(expenseId) {
        // In a real implementation, fetch expense details via AJAX
        const expenses = {{ expenses|tojson }};
        const expense = expenses.find(e => e.id === expenseId);
        
        if (expense) {
            const content = `
                <div style="display: grid; gap: 1rem;">
                    <div>
                        <strong style="color: var(--gray);">Category:</strong>
                        <div style="font-size: 1.125rem; margin-top: 0.25rem;">${expense.category}</div>
                    </div>
                    <div>
                        <strong style="color: var(--gray);">Amount:</strong>
                        <div style="font-size: 1.125rem; margin-top: 0.25rem;">${expense.currency} ${parseFloat(expense.amount).toFixed(2)}</div>
                    </div>
                    <div>
                        <strong style="color: var(--gray);">Date:</strong>
                        <div style="margin-top: 0.25rem;">${expense.expense_date}</div>
                    </div>
                    <div>
                        <strong style="color: var(--gray);">Status:</strong>
                        <div style="margin-top: 0.25rem;">
                            <span class="badge badge-${expense.status === 'approved' ? 'success' : expense.status === 'rejected' ? 'danger' : 'warning'}">${expense.status.toUpperCase()}</span>
                        </div>
                    </div>
                    <div>
                        <strong style="color: var(--gray);">Description:</strong>
                        <div style="margin-top: 0.25rem;">${expense.description || 'No description provided'}</div>
                    </div>
                    <div>
                        <strong style="color: var(--gray);">Submitted:</strong>
                        <div style="margin-top: 0.25rem;">${expense.created_at}</div>
                    </div>
                </div>
            `;
            document.getElementById('modalContent').innerHTML = content;
            document.getElementById('detailsModal').style.display = 'flex';
        }
    }

    function closeModal() {
        document.getElementById('detailsModal').style.display = 'none';
    }

    // Close modal on outside click
    document.getElementById('detailsModal').addEventListener('click', function(e) {
        if (e.target === this) closeModal();
    });
</script>
{% endblock %}